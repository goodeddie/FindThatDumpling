<!DOCTYPE html>
<html>
	<head>
		<!--
		
		Find that Dumpling!

		Created by Allice and Eddie

		Special thanks to Batiste Bieler and contributors for Sprite.js and more
		
		All rights and permissions reserved to Che Chan.

		-->
		<title>
			Find that Dumpling!
		</title>
		<meta name="viewport" content="user-scalable=no, width=device-width">
		
		<script src="sprite.js"></script>
		<script src="lib/collision.js"></script>
		<script type="text/javascript">
		window.onload = function() {
		
			sjs.debug = true;
		
			var scene = sjs.Scene({w:320, h:320});
			scene.loadImages([
				'img/test/star.png',
				'img/person.png',
				'img/theperson.png',
				'img/AllyIcon01.png',
				],
				function() {
					engine = new Engine(scene);
					ticker = scene.Ticker(function() {
						engine.run();
					});
					engine.setTicker(ticker);
					ticker.run();
				});
			};
			
			function Engine(scene) {
				var that = this;
				
				this.scene = scene;
				this.background = this.scene.Layer("background");
				this.background.img = null;
				this.sprites_layer = this.scene.Layer("sprites_layer");
				this.ticker = null;
				this.inputs = scene.Input();
				this.setTicker = function(ticker) {
					this.ticker = ticker;
				}
				this.peopleFound = [];
				
				//////////////////////////////////////////////////////////////////
				// CREATE THE PEOPLE                                            //
				//////////////////////////////////////////////////////////////////
				this.people = [];
				this.people.push(['img/AllyIcon01.png', 'img/AllyIcon01.png', 'You found me!', 'Get off me!']);
				this.people.push(['img/AllyIcon01.png', 'img/AllyIcon01.png', 'You found me!', 'Get off me!']);
				
				//////////////////////////////////////////////////////////////////
				// UPDATE MOVEMENT                                              //
				//////////////////////////////////////////////////////////////////
				_updateMovement = function(sprite) {
					_handleClick(sprite);
					
					_handleBounds(sprite);
					
					sprite.applyVelocity();
				};
				
				//////////////////////////////////////////////////////////////////
				// HANDLE CLICK                                                 //
				//////////////////////////////////////////////////////////////////
				_handleClick = function(sprite) {
					if (that.inputs.mousedown) {
						if (sjs.collision.isPointInImage(
							that.inputs.mouse.position.x - sprite.x,
							that.inputs.mouse.position.y - sprite.y,
							sprite.w,
							sprite.h,
							sprite.img)
						) {
							_handleDialogue(sprite);
							if (sprite.mass == 1) {
								sprite.mass = 0;
								that.people.splice(_addNextPerson(), 1);
							}
						}
						else {
							// not touched
						}
					}
				}
				
				//////////////////////////////////////////////////////////////////
				// HANDLE DIALOGUE                                              //
				//////////////////////////////////////////////////////////////////
				_handleDialogue = function(sprite) {
					if (sprite.mass == 1) {
						that.background.img = that.scene.Sprite(sprite.goodDialogueImg, {
							"layer": that.sprites_layer,
							"x": 0,
							"y": 0,
							"w": that.scene.w,
							"h": that.scene.h,
							"opacity": .1
						});
					}
					else {
						that.background.img = that.scene.Sprite(sprite.badDialogueImg, {
							"layer": that.sprites_layer,
							"x": 0,
							"y": 0,
							"w": that.scene.w,
							"h": that.scene.h,
							"opacity": .1
						});
					}
					//alert(that.background.img.opacity);
					that.background.img.update();alert(that.background.img.opacity);alert(sprite.opacity);
				}
					
				//////////////////////////////////////////////////////////////////
				// HANDLE BOUNDS                                                //
				//////////////////////////////////////////////////////////////////
				_handleBounds = function(sprite) {
					if ((sprite.xv < 0) && (sprite.x + sprite.xv) < 0) {
						sprite.setVelocity(sprite.xv * -1, sprite.yv);
					}
					else if ((sprite.xv > 0) && (((sprite.x + sprite.xv) + sprite.w) > sprite.layer.w)) {
						sprite.setVelocity(sprite.xv * -1, sprite.yv);
					}
					
					if ((sprite.yv < 0) && ((sprite.y + sprite.yv) < 0)) {
						sprite.setVelocity(sprite.xv, sprite.yv * -1);
					}
					else if ((sprite.yv > 0) && (((sprite.y + sprite.yv) + sprite.h) > sprite.layer.h)) {
						sprite.setVelocity(sprite.xv, sprite.yv * -1);
					}
				};
				
				//////////////////////////////////////////////////////////////////
				// ADD A PERSON                                                 //
				//////////////////////////////////////////////////////////////////
				_addPerson = function(gImg, bImg, gText, bText) {
					RandomX = Math.floor((Math.random() * (that.scene.w - 32)));
					RandomY = Math.floor((Math.random() * (that.scene.h - 32)));
					RandomXv = Math.floor((Math.random() * 2) + 1);
					RandomYv = Math.floor((Math.random() * 2) + 1);
					
					person = that.scene.Sprite("img/person.png", {
						"layer": that.sprites_layer,
						"x": RandomX,
						"y": RandomY,
						"w": 32,
						"h": 32,
						"xv": RandomXv,
						"yv": RandomYv,
						"mass": 1
					});
					
					person.goodDialogueImg = gImg;
					person.badDialogueImg = bImg;
					person.goodText = gText;
					person.badText = bText;
					
					that.peopleFound.push(person);
				};
				
				//////////////////////////////////////////////////////////////////
				// ADD NEXT PERSON                                              //
				// - returns person id in array                                 //
				//////////////////////////////////////////////////////////////////
				_addNextPerson = function() {
					var rand = Math.floor(Math.random() * that.people.length);
					
					_addPerson(that.people[rand][0], that.people[rand][1], that.people[rand][2], that.people[rand][3]);
					
					return rand;
				};
				
				//////////////////////////////////////////////////////////////////
				// CREATE GAME LOOP                                             //
				//////////////////////////////////////////////////////////////////
				this.run = function() {
					// Update sprites layer
					for (var i in that.peopleFound) {
						_updateMovement(that.peopleFound[i]);
						
						that.peopleFound[i].update();
					}
					
					if (that.people.length == 0) {
						alert("You win!");
					}
				}
				
				//////////////////////////////////////////////////////////////////
				// START THE GAME                                               //
				//////////////////////////////////////////////////////////////////
				_addNextPerson();
			}
	</script>
	</head>
	<body>
		Click on the right Dumpling!
		<span id="debug"></span>
	</body>
</html>