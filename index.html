<!DOCTYPE html>
<html>
	<head>
		<!--
		
		Find that Dumpling!

		Created by Allice and Eddie

		Special thanks to Batiste Bieler and contributors for Sprite.js and more
		
		All rights and permissions reserved to Che Chan.

		-->
		<title>
			Find that Dumpling!
		</title>
		<meta name="viewport" content="user-scalable=no, width=device-width">
		
		<script src="sprite.js"></script>
		<script src="lib/collision.js"></script>
		<script type="text/javascript">
		window.onload = function() {
		
			sjs.debug = true;
		
			var scene = sjs.Scene({w:512, h:320});
			var layer = scene.Layer("game_layer");
			scene.loadImages([
				'img/test/star.png',
				'img/AllyIcon01.png',
				],
				function() {
					engine = new Engine(scene, layer);
					ticker = scene.Ticker(function() {
						engine.run();
					});
					engine.setTicker(ticker);
					ticker.run();
				});
			};
			
			function Engine(scene, layer) {
				var that = this;
				
				this.scene = scene;
				this.layer = layer;
				this.ticker = null;
				this.inputs = scene.Input();
				this.setTicker = function(ticker) {
					this.ticker = ticker;
				}
				this.spriteList = [];
				
				//////////////////////////////////////////////////////////////////
				//TESTTTTTTTTTTTT                                               //
				//////////////////////////////////////////////////////////////////
				var s = layer.Sprite('img/test/star.png');
				s.move(0, 0);
				s.update();
				//////////////////////////////////////////////////////////////////
				//TESTTTTTTTTTTTT                                               //
				//////////////////////////////////////////////////////////////////
				
				//////////////////////////////////////////////////////////////////
				// UPDATE MOVEMENT                                              //
				//////////////////////////////////////////////////////////////////
				_updateMovement = function(sprite) {
					_handleClick(sprite);
					
					_handleBounds(sprite);
					
					sprite.applyVelocity();
				};
				
				//////////////////////////////////////////////////////////////////
				// HANDLE CLICK                                                 //
				//////////////////////////////////////////////////////////////////
				_handleClick = function(sprite) {
					if (that.inputs.mousedown) {
						if (sjs.collision.isPointInImage(
							e.clientX - that.player.x - scene.dom.offsetLeft,
							e.clientY - that.player.y - scene.dom.offsetTop,
							that.player.w,
							that.player.h,
							that.player.img)
						) {
							//something
						}
					}
				}
					
				//////////////////////////////////////////////////////////////////
				// HANDLE BOUNDS                                                //
				//////////////////////////////////////////////////////////////////
				_handleBounds = function(sprite) {
					if ((sprite.xv < 0) && (sprite.x + sprite.xv) < 0) {
						sprite.setVelocity(sprite.xv * -1, sprite.yv);
					}
					else if ((sprite.xv > 0) && (((sprite.x + sprite.xv) + sprite.w) > sprite.layer.w)) {
						sprite.setVelocity(sprite.xv * -1, sprite.yv);
					}
					
					if ((sprite.yv < 0) && ((sprite.y + sprite.yv) < 0)) {
						sprite.setVelocity(sprite.xv, sprite.yv * -1);
					}
					else if ((sprite.yv > 0) && (((sprite.y + sprite.yv) + sprite.h) > sprite.layer.h)) {
						sprite.setVelocity(sprite.xv, sprite.yv * -1);
					}
				};
				
				//////////////////////////////////////////////////////////////////
				// ADD A PERSON                                                 //
				//////////////////////////////////////////////////////////////////
				_addPerson = function() {
					RandomX = Math.floor((Math.random() * that.scene.w) - 20);
					RandomY = Math.floor((Math.random() * that.scene.h) - 19);
					RandomXv = Math.floor((Math.random() * 4) + 1);
					RandomYv = Math.floor((Math.random() * 4) + 1);
					
					person = that.scene.Sprite("img/person.png", {
						"layer": that.layer,
						"x": RandomX,
						"y": RandomY,
						"w": 20,
						"h": 19,
						"xv": RandomXv,
						"yv": RandomYv
					});
					
					person.setXOffset(5);
					person.setYOffset(7);
					
					that.spriteList.push(person);
				};
				
				_addPerson();
				
				//////////////////////////////////////////////////////////////////
				// HOW TO HANDLE MOUSE CLICK                                    //
				//////////////////////////////////////////////////////////////////
				scene.dom.onclick = function(e) {
					if (sjs.collision.isPointInImage(
						e.clientX - s.x - scene.dom.offsetLeft,
						e.clientY - s.y - scene.dom.offsetTop,
						s.w,
						s.h,
						s.img)
					) {
						alert("star touched");
					}
				};
				
				//////////////////////////////////////////////////////////////////
				//Create run method which will be called each time the          //
				//game loop runs                                                //
				//////////////////////////////////////////////////////////////////
				this.run = function() {
					//Update and Paint all images
					for (var i in that.spriteList) {
						_updateMovement(that.spriteList[i]);
						
						that.spriteList[i].update();
					}
				}
			}
	</script>
	</head>
	<body>
		Click on a point or press qwer
		<span id="debug"></span>
	</body>
</html>