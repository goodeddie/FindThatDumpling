<!DOCTYPE html>
<html>
	<head>
		<!--
		
		Find that Dumpling!

		Created by Allice and Eddie

		Special thanks to Batiste Bieler and contributors for Sprite.js and more
		
		All rights and permissions reserved to Che Chan.

		-->
		<title>
			Find that Dumpling!
		</title>
		<meta name="viewport" content="user-scalable=no, width=device-width">
		
		<script src="sprite.js"></script>
		<script src="lib/collision.js"></script>
		<script type="text/javascript">
		window.onload = function() {
		
			sjs.debug = true;
		
			var scene = sjs.Scene({w:512, h:320});
			var layer = scene.Layer("game_layer");
			scene.loadImages([
				'img/person.png',
				'img/theperson.png',
				'img/AllyIcon01.png',
				],
				function() {
					engine = new Engine(scene, layer);
					ticker = scene.Ticker(function() {
						engine.run();
					});
					engine.setTicker(ticker);
					ticker.run();
				});
			};
			
			function Engine(scene, layer) {
				var that = this;
				
				this.scene = scene;
				this.layer = layer;
				this.ticker = null;
				this.inputs = scene.Input();
				this.setTicker = function(ticker) {
					this.ticker = ticker;
				}
				this.peopleFound = [];
				
				//////////////////////////////////////////////////////////////////
				// CREATE THE PEOPLE                                            //
				//////////////////////////////////////////////////////////////////
				this.people = [];
				this.people.push(['img/AllyIcon01.png', 'You found me!', 'Get off me!']);
				
				//////////////////////////////////////////////////////////////////
				// UPDATE MOVEMENT                                              //
				//////////////////////////////////////////////////////////////////
				_updateMovement = function(sprite) {
					//_handleClick(sprite);
					
					_handleBounds(sprite);
					
					sprite.applyVelocity();
				};
				
				scene.dom.onclick = function(e) {
					if(sjs.collision.isPointInImage(
						e.clientX - that.peopleFound[0].x - scene.dom.offsetLeft,
						e.clientY - that.peopleFound[0].y - scene.dom.offsetTop,
						that.peopleFound[0].w,
						that.peopleFound[0].h,
						that.peopleFound[0].img)
					) {
						alert("star touched");
					}
					else {
						alert("star not touched");
					}
				}
				
				//////////////////////////////////////////////////////////////////
				// HANDLE CLICK                                                 //
				//////////////////////////////////////////////////////////////////
				_handleClick = function(sprite) {
					if (that.inputs.mousedown) {
						/*
						alert(that.inputs.mouse.position.x);
						alert(that.inputs.mouse.position.y);
						
						alert(sprite.x);
						alert(sprite.y);
						
						alert(that.inputs.mouse.position.x - sprite.x);
						alert(that.inputs.mouse.position.y - sprite.y);
						*/
						if (sjs.collision.isPointInImage(
							that.inputs.mouse.position.x - sprite.x,// + scene.dom.offsetLeft,
							that.inputs.mouse.position.y - sprite.y,// + scene.dom.offsetTop,
							sprite.w,
							sprite.h,
							sprite.img)
						) {
							_handleDialogue(sprite, sprite.mass);
							if (sprite.mass == 1) {
								sprite.mass = 0;
								that.people.splice(_addNextPerson(), 1);
							}
						}
						else {
							alert("not touched");
						}
					}
				}
				
				//////////////////////////////////////////////////////////////////
				// HANDLE DIALOGUE                                              //
				//////////////////////////////////////////////////////////////////
				_handleDialogue = function(sprite, mass) {
					if (sprite.mass == 1) {
						
					}
					else {
						
					}
				}
					
				//////////////////////////////////////////////////////////////////
				// HANDLE BOUNDS                                                //
				//////////////////////////////////////////////////////////////////
				_handleBounds = function(sprite) {
					if ((sprite.xv < 0) && (sprite.x + sprite.xv) < 0) {
						sprite.setVelocity(sprite.xv * -1, sprite.yv);
					}
					else if ((sprite.xv > 0) && (((sprite.x + sprite.xv) + sprite.w) > sprite.layer.w)) {
						sprite.setVelocity(sprite.xv * -1, sprite.yv);
					}
					
					if ((sprite.yv < 0) && ((sprite.y + sprite.yv) < 0)) {
						sprite.setVelocity(sprite.xv, sprite.yv * -1);
					}
					else if ((sprite.yv > 0) && (((sprite.y + sprite.yv) + sprite.h) > sprite.layer.h)) {
						sprite.setVelocity(sprite.xv, sprite.yv * -1);
					}
				};
				
				//////////////////////////////////////////////////////////////////
				// ADD A PERSON                                                 //
				//////////////////////////////////////////////////////////////////
				_addPerson = function(img, gText, bText) {
					RandomX = Math.floor((Math.random() * (that.scene.w - 20)));
					RandomY = Math.floor((Math.random() * (that.scene.h - 19)));
					RandomXv = 0;//Math.floor((Math.random() * 2) + 1);
					RandomYv = 0;//Math.floor((Math.random() * 2) + 1);
					
					person = that.scene.Sprite("img/person.png", {
						"layer": that.layer,
						"x": RandomX,
						"y": RandomY,
						"w": 20,
						"h": 19,
						"xv": RandomXv,
						"yv": RandomYv,
						"mass": 1
					});
					person.setXOffset(5);
					person.setYOffset(7);
					
					person.dialogueImg = img;
					person.goodText = gText;
					person.badText = bText;
					
					that.peopleFound.push(person);
				};
				
				//////////////////////////////////////////////////////////////////
				// ADD NEXT PERSON                                              //
				// - returns person id in array                                 //
				//////////////////////////////////////////////////////////////////
				_addNextPerson = function() {
					var rand = Math.floor(Math.random() * that.peopleFound.length);
					
					_addPerson(that.people[rand][0], that.people[rand][1], that.people[rand][2]);
					
					return rand;
				};
				
				//////////////////////////////////////////////////////////////////
				// CREATE GAME LOOP                                             //
				//////////////////////////////////////////////////////////////////
				this.run = function() {
					//Update and Paint all images
					for (var i in that.peopleFound) {
						_updateMovement(that.peopleFound[i]);
						
						that.peopleFound[i].update();
					}
					
					if (that.people.length == 0) {
						alert("You win!");
					}
				}
				
				//////////////////////////////////////////////////////////////////
				// START THE GAME                                               //
				//////////////////////////////////////////////////////////////////
				_addNextPerson();
			}
	</script>
	</head>
	<body>
		Click on the right Dumpling!
		<span id="debug"></span>
	</body>
</html>